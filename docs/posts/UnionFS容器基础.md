# UnionFS : 原理及应用

## 1.什么是UnionFS？

> 推荐两篇论文
>
> [Unionfs: User- and Community-Oriented Development of a Unification File System](https://unionfs.filesystems.org/docs/sipek-ols2006/index.html)
>
> [Versatility and Unix Semantics in Namespace Unification](https://www.filesystems.org/docs/unionfs-tos/unionfs.html)
>
> 两篇篇精品博客
>
> [UnionFS : A File System of a Container](https://medium.com/@knoldus/unionfs-a-file-system-of-a-container-2136cd11a779)
>
> [深入解读Docker的Union File System技术](https://zhuanlan.zhihu.com/p/645839021)

#### 在认识UnionFS之前，先自己问一个问题：传统的linux文件系统，如 ext2、ext3、ext4、XFS 等，难道不香么？

> 传统的linux文件系统不支持文件共享

假设你有一个docker，docker上有 10 个容器实例，每个实例都使用相同大小为 1GB 的基础镜像。但如果你使用的是传统linux文件系统，那就很抱歉了：传统文件系统不支持共享！！！每个容器会在本地磁盘上独立存储这 1GB 的实例，这就导致总共占用的物理内存将达到 10GB！夸张一点，如果是 100 个实例呢？那不就要 100GB 了？

现在你用的是UnionFS。你会发现，UnionFS有一个叫做写时复制（Copy on Write，CoW）的技术。每个实例都共用那个 1GB 的基础镜像，在你需要在某一个容器实例对文件进行写操作时，写时复制机制会创建文件的副本并将修改写入副本中，而不是直接修改基础镜像中的文件。这样，多个容器实例可以共享相同的基础镜像，因为每个容器只需要记录自己的更改，而不必在每个实例中保存完整的文件系统副本。10GB 变 1GB ，很好的节约了磁盘空间。

> 传统linux文件系统的有效负载太大

容器的延迟启动涉及将容器所需的基础镜像文件复制到容器的命名空间。考虑你用的是传统linux文件系统，那么你就会发现它并没有提供什么抽象来帮助你快速启动，你所需要做的是将完整的镜像文件加载到容器的**命名空间**中。在这个过程中，如果镜像层有大量数据需要复制，可能会影响容器的启动时间，因为需要花费更多时间来处理和复制这些数据。

现在你用的是UnionFS。你会发现，UnionFS有一个神奇的分层结构，它允许允许容器引擎利用镜像层的共享和复用。这种结构允许多个镜像层以分层方式叠加，但它们实际上只读取其中的一层。这样，容器的启动不需要复制整个镜像，而是可以重用共享的只读镜像层，并加载一个可写层进行修改。这样的设计有助于快速启动容器，并减少存储资源的重复使用。

> 传统linux文件系统无法将不同的文件系统和分区放在一个文件目录下，没有一个连贯统一的用户视图

看到这里的都知道，在传统的linux文件系统中，切换到不同的分区需要手动切换，且无法用单个界面来操作所有分区和不同文件系统的文件。但在UnionFS中，它允许将多个文件系统层叠在一起（也就是后面提到的挂载），形成一个统一的文件系统视图。用户无需将其物理合并，就可以享受到在一个位置便捷地查看所有文件。

> 传统linux文件系统不支持版本控制和回滚

这也是大家都知道的事，但UnionFS实现了。通过**分层结构**和**写时复制**，它允许用户创建快照并在需要时回滚到之前的状态。只需要重新挂载文件系统以前的快照版本或层级就行了。

#### 所以UnionFS是什么我们可以给出定义了

~~**Unionfs** 是 Linux、FreeBSD 和 NetBSD 的文件系统服务，它实现了其他文件系统的联合挂载。它允许将单独文件系统（称为分支 branches）的文件和目录透明地覆盖，形成一个单一的连贯文件系统。在合并的分支中具有相同路径的目录的内容将一起显示在新的虚拟文件系统中的单个合并目录中。~~

不说废话，我简单总结 **UnionFS** 是一个

> 可以多个文件系统进行**逻辑合并**并统一管理、
>
> 对**下层只读**可以回滚、
>
> **上层可写**分离系统文件、
>
> **分层结构**和**写时复制**两大机制
>
> 的快速的，透明的**文件系统**

UnionFS允许用户将多个不同位置的文件系统联合挂载（mount）为一个单一的文件系统。它的**主要特点**是能够将多个目录合并为一个单一的目录，并显示为一个整体。UnionFS 的**工作方式**是通过层叠不同的文件系统，创建一个层次结构的文件系统。它支持在一个文件系统上创建一个联合的视图，将多个只读目录（通常是基础镜像）和一个可写目录（用于存储更改）合并为一个虚拟文件系统。当对文件进行读取时，它会按照一定规则（例如，先在可写层搜索文件，然后在只读层搜索）查找文件。UnionFS 提供了一种**灵活的方式来管理和组织文件系统**。它常用于需要将多个文件系统或目录合并为一个统一视图的情况，例如在嵌入式系统、虚拟化环境、容器技术中等。UnionFS 允许用户在不修改原始文件系统的情况下，将多个文件系统合并到一个目录结构中，为用户提供更便捷、更高效的文件管理方式。

## 2.UnionFS的工作原理与实现方式

> 请注意！Branch (分支) 和 Layer (层叠) 都代表文件系统，但在不同情况下有不同称呼。 

### 1.分层文件系统到底是什么？

分层文件系统是一种文件系统的组织结构，它基于多层结构，允许将多个层叠的文件系统叠加在一起，形成一个整体。这些层叠的文件系统可以提供多个不同层次的视图，并在文件访问时按照一定的规则进行搜索和读取。

在分层文件系统中，通常存在一个底层基础镜像（Base Image），它包含文件系统的基本内容，是只读的。然后在该基础上可以创建多个叠加层（Overlay Layers），这些层可以包含新增、修改或删除的文件。这些叠加层的改动不会影响底层的基础镜像，使得用户可以在不改变基础内容的情况下，对文件系统进行修改和定制。

![UnionfsLayer](E:\Documents\MyNotes\images\UnionfsLayer.webp)

 <center>容器的分层文件结构</center>

上图是由三个「镜像层」(Image Layer) 和一个「写时复制层」(Container Layer) 组成的容器的文件系统结构。这种结构利用联合文件系统的特性，将不同的镜像层以**只读**方式叠加，而容器层则**允许**对镜像的内容进行**修改和添加**，同时不影响基础镜像的完整性。这种组合允许容器共享基础镜像的文件，并在此基础上进行个性化的修改，同时保持原有的镜像不受影响。

### 2.写时复制的工作原理

写时复制（Copy-on-Write，CoW）是指在创建一个数据副本时，只有在需要修改数据时才会进行实际的复制。当多个资源（例如进程或容器）共享相同的资源时，只要有一个需要对资源进行写操作，系统就会复制该资源，以确保每个进程或容器都可以在需要时访问其自己的独立副本，而不影响其他共享者。

工作原理是这样的：

1. 原始数据被**共享**，多个进程或容器**引用**同一块数据。
2. 当其中一个进程或容器需要对数据进行修改时，系统会复制这块数据，创建一个新的副本。
3. 之后的写操作都会针对这个新的副本进行，而原始的数据保持不变，其他进程或容器继续引用原始数据。

![v2-a96889ad4e9676a787720366da5d3e51_720w](E:\Pictures\Camera Roll\v2-a96889ad4e9676a787720366da5d3e51_720w.webp)

> 以上图为例，调用`fork()`，创建新的进程副本，其为父进程的完全复制，称为子进程。在初始状态下，父进程和子进程共用同一块数据。
>
> 对子进程进行写操作，系统将父进程数据复制并修改，写入新的空间。
>
> 父进程完全不受影响，子进程指向新的地址，写时复制完成。

### 3.挂载实现虚拟的单一文件系统

挂载 (mount) 是指将存储设备或文件系统连接到计算机的文件目录树中的过程。通过挂载，设备或文件系统将被视作 **UnionFS** 的一部分，你可以通过指定的目录访问和管理被挂载的设备或文件系统。

![FSmount](E:\Documents\MyNotes\images\FSmount.webp)

在上图中，我们可以看到UnionFS可以挂载不同的文件系统，所有不同文件系统中的文件被映射到/mnt目录下，用户在进行访问是只需访问根目录，并可以对所有文件进行操作。用户无需关心这些文件所在的位置，用户看见的只是一个普通的文件系统根目录而已。Union Mount 实现了将多个文件系统合并为一个单一的虚拟文件系统，提供了更灵活和高效的文件管理。

## 3.联合文件系统在架构上的应用

### 1.OverlayFS

![overlay-filesystems](E:\Documents\MyNotes\images\overlay-filesystems.png)

<center>OverlayFS</center>

OverlayFS 是 Linux 内核中的一个存储文件系统，是一种联合文件系统的实现方式之一。它提供了一种将多个文件系统层叠在一起以形成单一文件系统的机制。OverlayFS 允许将两个不同的文件系统合并成一个，其中一个为底层（称为底层文件系统），另一个是只读的或者可写的文件系统（称为上层文件系统）。

在 OverlayFS 中，上层文件系统叠加在底层文件系统之上，这使得上层文件系统的修改可以以一种透明的方式覆盖底层文件系统的内容。OverlayFS 通常用于容器技术中，例如 Docker，用于创建轻量级容器的文件系统。其实现方式类似于联合挂载，但使用了更高效的技术来实现文件系统的层叠。

![OverlayFS](E:\Documents\MyNotes\images\OverlayFS.jpg)

<center>Overlay分层</center>

从上图可知，OverlayFS 文件系统主要有三个角色，lowerdir、upperdir 和 merged。

- lowerdir 是只读层，用户不能修改这个层的文件；
- upperdir 是可读写层，用户能够修改这个层的文件；
- merged 是合并层，把 lowerdir 层和 upperdir 层的文件合并展示。

OverlayFS 文件系统的作用是合并 upper 目录和 lower 目录的中的内容，如果 upper 目录与 lower 目录同时存在同一文件或目录，那么 OverlayFS 文件系统怎么处理呢？

- 如果 upper 和 lower 目录下同时存在同一文件，那么按 upper 目录的文件为准。比如 upper 与 lower 目录下同时存在文件 a.txt，那么按 upper 目录的 a.txt 文件为准。
- 如果 upper 和 lower 目录下同时存在同一目录，那么把 upper 目录与 lower 目录的内容合并起来。比如 upper 与 lower 目录下同时存在目录 test，那么把 upper 目录下的 test 目录中的内容与 lower 目录下的 test 目录中的内容合并起来。

通过介绍，我们可以知道OverlayFS 是联合文件系统的一种实现。由于OverlayFS被集成到了linux内核中，所以以OverlayFS代理UnionFS讲述。

### 2.循环设备

wiki百科解释：

> **/dev/loop**（或称**vnd** (vnode disk)、**lofi**（循环文件接口））在[类Unix系统](https://zh.wikipedia.org/wiki/类Unix系统)中是一种[伪设备](https://zh.wikipedia.org/wiki/设备文件系统)，这种设备使得[文件](https://zh.wikipedia.org/wiki/计算机文件)可以如同[块设备](https://zh.wikipedia.org/wiki/设备文件系统)一般被访问。
>
> 在使用之前，循环设备必须与现存文件系统上的文件相关联。这种关联将提供给用户一个[应用程序接口](https://zh.wikipedia.org/wiki/应用程序接口)，接口将允许文件视为块特殊文件（参见[设备文件系统](https://zh.wikipedia.org/wiki/设备文件系统)）使用。因此，如果文件中包含一个完整的[文件系统](https://zh.wikipedia.org/wiki/文件系统)，那么这个文件就能如同磁盘设备一般被[挂载](https://zh.wikipedia.org/wiki/挂载)。
>
> 这种设备文件经常被用于光盘或是磁盘镜像。通过[循环挂载](https://zh.wikipedia.org/w/index.php?title=循环挂载&action=edit&redlink=1)来挂载包含文件系统的文件，便使处在这个文件系统中的文件得以被访问。这些文件将出现在[挂载点](https://zh.wikipedia.org/wiki/挂载点)目录。如果挂载目录中本身有文件，这些文件在挂载后将被禁止使用。
>
> 一个循环设备或许能允许在重定向过程中进行一些数据处理。例如，设备可能是一个被加密文件的解密形式。在这种情况下，与循环设备相关的文件可能是另一种伪设备。当设备包含加密文件系统时，这种数据处理十分有用。如果数据处理得到支持且原文件被加密，循环设备将是此加密文件的解密形式并且设备可以如同普通文件系统一般被挂载。

简单来讲，我们可以将循环设备理解为一种接口或虚拟设备，它是一种不存在与物理上的设备。我们将通过循环设备来创建一个包含文件系统的文件（通常是一个镜像文件），并把这个文件当作一个设备来挂载到提通知。

wiki上对于**块设备**的定义是“*块设备是指与系统间用块的方式移动数据的设备*”，我们可以简单理解为分区。

循环设备可以通过与文件关联，将其创建为一个虚拟磁盘，使其具备类似物理磁盘的特性，比如分区、格式化和挂载等。

### 3.linux文件系统实现

![vfsUnionfs](E:\Documents\MyNotes\images\vfsUnionfs.svg)
